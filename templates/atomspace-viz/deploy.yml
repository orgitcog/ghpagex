# Sample workflow for building and deploying AtomSpace visualizations to GitHub Pages
#
# To get started with OpenCog AtomSpace see: https://wiki.opencog.org/w/AtomSpace
#
name: Deploy AtomSpace Visualizations to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: [$default-branch]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
      
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      
      - name: Create graphs directory if it doesn't exist
        run: mkdir -p graphs
      
      - name: Generate visualizations
        run: |
          # Make the generation script executable if it exists
          if [ -f generate-viz.sh ]; then
            chmod +x generate-viz.sh
            ./generate-viz.sh
          else
            # Default: convert all .dot files to SVG and create index
            mkdir -p public
            
            # Convert DOT files to SVG
            if ls graphs/*.dot 1> /dev/null 2>&1; then
              for dot_file in graphs/*.dot; do
                base_name=$(basename "$dot_file" .dot)
                dot -Tsvg "$dot_file" -o "public/${base_name}.svg"
              done
            fi
            
            # Generate HTML index
            cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <title>AtomSpace Visualizations</title>
              <style>
                  body { 
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      margin: 0;
                      padding: 2em;
                      background: #f5f5f5;
                  }
                  h1 { color: #333; }
                  .viz { 
                      background: white;
                      border: 1px solid #ddd;
                      border-radius: 8px;
                      margin: 1em 0;
                      padding: 1.5em;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .viz h2 { 
                      color: #555;
                      margin-top: 0;
                  }
                  img {
                      max-width: 100%;
                      height: auto;
                  }
              </style>
          </head>
          <body>
              <h1>ðŸ§  AtomSpace Visualizations</h1>
              <p>Visualization of AtomSpace graphs, attention values, and PLN inference traces.</p>
          EOF
            
            if ls public/*.svg 1> /dev/null 2>&1; then
              for svg_file in public/*.svg; do
                base_name=$(basename "$svg_file")
                display_name="${base_name%.svg}"
                {
                  echo '              <div class="viz">'
                  echo "                  <h2>${display_name}</h2>"
                  echo "                  <img src=\"${base_name}\" alt=\"${display_name}\">"
                  echo '              </div>'
                } >> public/index.html
              done
            else
              cat >> public/index.html << 'EOF'
              <p>No visualizations found. Add .dot files to the graphs/ directory.</p>
          EOF
            fi
            
            cat >> public/index.html << 'EOF'
          </body>
          </html>
          EOF
          fi
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
